<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="manifest.json"> <title>SCA Command</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- PRO THEME --- */
        :root { 
            --bg-dark: #0f172a; --panel: #1e293b; --border: #334155; 
            --accent: #0ea5e9; --text: #f8fafc; --danger: #ef4444; --success: #10b981;
            --nav-height: 65px;
        }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; padding: 0; background: #000; font-family: 'Inter', sans-serif; color: var(--text); overflow: hidden; height: 100dvh; display: flex; }

        /* --- LAYOUT --- */
        #map-container { flex: 1; position: relative; height: 100%; z-index: 1; }
        #map { width: 100%; height: 100%; background: #1a1a1a; cursor: crosshair; }

        /* DESKTOP SIDEBAR */
        #sidebar {
            width: 380px; height: 100%; background: var(--bg-dark); 
            border-right: 1px solid var(--border); display: flex; flex-direction: column;
            z-index: 100; box-shadow: 2px 0 10px rgba(0,0,0,0.3);
        }

        /* MOBILE OVERRIDES */
        @media (max-width: 768px) {
            body { flex-direction: column-reverse; } 
            
            #sidebar {
                position: absolute; bottom: var(--nav-height); left: 0; width: 100%; 
                height: 0; border-right: none; border-top: 1px solid var(--border);
                transition: height 0.25s cubic-bezier(0.2, 0.8, 0.2, 1);
                overflow: hidden;
            }
            #sidebar.open { height: 60vh; }
            
            #mobile-nav {
                height: var(--nav-height); background: var(--bg-dark); 
                border-top: 1px solid var(--border); display: flex; z-index: 200;
                padding-bottom: env(safe-area-inset-bottom);
            }
        }
        @media (min-width: 769px) { #mobile-nav { display: none; } }

        /* --- UI ELEMENTS --- */
        .sidebar-header { padding: 15px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.2); }
        .app-title { font-weight: 700; color: var(--text); letter-spacing: 0.5px; font-size: 14px; }
        .lock-icon { cursor: pointer; opacity: 0.4; font-size: 16px; transition: 0.2s; }
        .lock-icon.unlocked { opacity: 1; color: var(--success); }

        /* TABS */
        .desktop-tabs { display: flex; border-bottom: 1px solid var(--border); }
        .dt-btn { flex: 1; padding: 14px; background: none; border: none; color: #64748b; font-weight: 600; font-size: 12px; cursor: pointer; border-bottom: 2px solid transparent; }
        .dt-btn:hover { color: var(--text); }
        .dt-btn.active { color: var(--accent); border-bottom-color: var(--accent); }

        .tab-content { flex: 1; overflow-y: auto; padding: 20px; display: none; }
        .tab-content.active { display: block; }

        /* MOBILE BUTTONS */
        .mn-btn { flex: 1; background: none; border: none; color: #64748b; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px; font-size: 9px; font-weight: 600; cursor: pointer; }
        .mn-btn svg { width: 22px; height: 22px; fill: currentColor; }
        .mn-btn.active { color: var(--accent); background: rgba(255,255,255,0.03); }

        /* FORMS */
        .input-group { margin-bottom: 15px; }
        .label { font-size: 11px; text-transform: uppercase; color: #94a3b8; font-weight: 700; margin-bottom: 6px; display: block; }
        .input-box { width: 100%; padding: 12px; background: var(--panel); border: 1px solid var(--border); color: white; border-radius: 6px; font-size: 14px; transition: border-color 0.2s; }
        .input-box:focus { border-color: var(--accent); outline: none; }

        .btn { width: 100%; padding: 12px; border-radius: 6px; border: none; font-weight: 600; font-size: 13px; cursor: pointer; color: white; display: flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s; }
        .btn:active { transform: translateY(1px); }
        .btn-primary { background: var(--accent); color: #0f172a; }
        .btn-danger { background: var(--danger); }
        .btn-dark { background: #334155; }
        
        /* MARKER TOOLS GRID */
        .tool-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .tool-btn { 
            background: var(--panel); border: 1px solid var(--border); color: var(--text); 
            padding: 15px; border-radius: 8px; cursor: pointer; display: flex; flex-direction: column; 
            align-items: center; gap: 8px; font-size: 11px; font-weight: 600; transition: 0.2s;
        }
        .tool-btn:hover { border-color: var(--accent); background: rgba(14, 165, 233, 0.1); }
        .tool-btn svg { width: 24px; height: 24px; fill: var(--text); }
        .tool-btn.active { border-color: var(--success); background: rgba(34, 197, 94, 0.1); color: var(--success); }
        .tool-btn.active svg { fill: var(--success); }

        /* OVERLAY MESSAGE */
        #map-overlay {
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(15, 23, 42, 0.95); border: 1px solid var(--accent); 
            padding: 10px 20px; border-radius: 30px; color: var(--text); font-size: 12px; font-weight: 600;
            z-index: 500; display: none; box-shadow: 0 4px 15px rgba(0,0,0,0.5); pointer-events: none;
        }

        /* --- MAP MARKERS --- */
        .marker-pin { width: 16px; height: 16px; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 8px rgba(0,0,0,0.5); }
        
        /* Custom Shapes */
        .shape-diamond { width: 14px; height: 14px; transform: rotate(45deg); border: 2px solid white; }
        .shape-square { width: 14px; height: 14px; border: 2px solid white; }
        .shape-circle { width: 14px; height: 14px; border-radius: 50%; border: 2px solid white; }

    </style>
</head>
<body>

    <aside id="sidebar">
        
        <div class="sidebar-header">
            <div class="app-title">SCA COMMAND</div>
            <div id="lockIcon" class="lock-icon" onclick="toggleAdmin()" title="Supervisor Access">üîí</div>
        </div>

        <div class="desktop-tabs">
            <button class="dt-btn active" onclick="switchTab('status')">STATUS</button>
            <button class="dt-btn" onclick="switchTab('work')">WORK</button>
            <button class="dt-btn" onclick="switchTab('mark')">MARKER</button>
            <button class="dt-btn" onclick="switchTab('chat')">CHAT</button>
        </div>

        <div id="tab-status" class="tab-content active">
            
            <div id="admin-panel" style="display:none; padding:15px; background:rgba(239,68,68,0.1); border-radius:8px; margin-bottom:20px; border:1px solid var(--danger);">
                <div style="font-size:10px; font-weight:700; color:var(--danger); margin-bottom:10px;">SUPERVISOR CONTROLS</div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px;">
                    <button class="btn btn-danger" onclick="clearMap()">Clear Markups</button>
                    <button class="btn btn-danger" onclick="clearUnits()">Clear Users</button>
                    <button class="btn btn-danger" onclick="clearTasks()">Clear Tasks</button>
                    <button class="btn btn-danger" onclick="clearChat()">Clear Chat</button>
                </div>
                <button class="btn btn-dark" style="margin-top:8px;" onclick="logoutAdmin()">Logout</button>
            </div>

            <div class="input-group">
                <span class="label">Identity</span>
                <input type="text" id="username" class="input-box" placeholder="Unit ID / Name">
            </div>
            
            <div class="input-group">
                <span class="label">Role</span>
                <select id="roleSelect" class="input-box">
                    <option value="blue">Employee</option>
                    <option value="red">Supervisor</option>
                    <option value="green">Manager</option>
                    <option value="white">Volunteer</option>
                </select>
            </div>

            <button class="btn btn-primary" id="trackBtn" onclick="toggleTracking()">START TRACKING</button>
            <div id="gps-status" style="text-align:center; font-size:11px; color:#64748b; margin-top:8px;">GPS Inactive</div>
        </div>

        <div id="tab-work" class="tab-content">
            <div id="manager-task-creator" style="display:none; margin-bottom:15px; padding-bottom:15px; border-bottom:1px solid var(--border);">
                <input type="text" id="newTaskInput" class="input-box" placeholder="Assign new task...">
                <button class="btn btn-primary" onclick="addTask()" style="margin-top:8px;">Assign Task</button>
            </div>
            <div id="taskList"></div>
        </div>

        <div id="tab-mark" class="tab-content">
            <div style="margin-bottom:15px; color:#94a3b8; font-size:12px; line-height:1.4;">
                Select a tool below, then tap on the map to place a marker.
            </div>
            
            <div class="tool-grid">
                <button class="tool-btn" onclick="selectTool('repair')">
                    <svg viewBox="0 0 24 24"><path d="M22.7 19l-9.1-9.1c.9-2.3.4-5-1.5-6.9-2-2-5-2.4-7.4-1.3L9 6 6 9 1.6 4.7C.4 7.1.9 10.1 2.9 12.1c1.9 1.9 4.6 2.4 6.9 1.5l9.1 9.1c.4.4 1 .4 1.4 0l2.3-2.3c.5-.4.5-1.1.1-1.4z"/></svg>
                    REPAIR
                </button>
                <button class="tool-btn" onclick="selectTool('hazard')">
                    <svg viewBox="0 0 24 24"><path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/></svg>
                    HAZARD
                </button>
                <button class="tool-btn" onclick="selectTool('blocked')">
                    <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.42 0-8-3.58-8-8 0-1.85.63-3.55 1.69-4.9L16.9 18.31C15.55 19.37 13.85 20 12 20zm6.31-3.1L7.1 5.69C8.45 4.63 10.15 4 12 4c4.42 0 8 3.58 8 8 0 1.85-.63 3.55-1.69 4.9z"/></svg>
                    BLOCKED
                </button>
                <button class="tool-btn" onclick="selectTool('note')">
                    <svg viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>
                    NOTE
                </button>
            </div>
        </div>

        <div id="tab-chat" class="tab-content">
            <div id="chat-feed" style="height:300px; overflow-y:auto; display:flex; flex-direction:column-reverse; margin-bottom:10px; border:1px solid var(--border); border-radius:6px; background:#0f172a;"></div>
            <div style="display:flex; gap:8px;">
                <input type="text" id="chatInput" class="input-box" style="margin:0;" placeholder="Message...">
                <button class="btn btn-primary" style="width:auto; margin:0; padding:0 15px;" onclick="sendMsg()">‚û§</button>
            </div>
        </div>

    </aside>

    <main id="map-container">
        <div id="map"></div>
        <div id="map-overlay">TAP MAP TO PLACE MARKER</div>
        
        <div style="position: absolute; top: 15px; right: 15px; z-index: 400; display: flex; flex-direction: column; gap: 8px;">
             <button onclick="toggleSat()" style="width:40px; height:40px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#1e293b; color:white; font-size:18px; cursor:pointer;">üõ∞Ô∏è</button>
             <button onclick="zoomToMe()" style="width:40px; height:40px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#1e293b; color:white; font-size:18px; cursor:pointer;">üéØ</button>
        </div>
    </main>

    <nav id="mobile-nav">
        <button class="mn-btn active" onclick="toggleTab('status')">
            <svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
            ID
        </button>
        <button class="mn-btn" onclick="toggleTab('work')">
            <svg viewBox="0 0 24 24"><path d="M19 3h-4.18C14.4 1.84 13.3 1 12 1c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm2 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/></svg>
            WORK
        </button>
        <button class="mn-btn" onclick="toggleTab('mark')">
            <svg viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>
            MARK
        </button>
        <button class="mn-btn" onclick="toggleTab('chat')">
            <svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/></svg>
            CHAT
        </button>
    </nav>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <script>
        // --- CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyCZkpLZt-r5e5B-KWBJiiGHMaHY3get6rM",
            authDomain: "sca-tak.firebaseapp.com",
            projectId: "sca-tak",
            storageBucket: "sca-tak.firebasestorage.app",
            messagingSenderId: "1073161858259",
            appId: "1:1073161858259:web:a860ae211ff3d32e1a7826",
            databaseURL: "https://sca-tak-default-rtdb.firebaseio.com"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // --- PWA SERVICE WORKER ---
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js')
            .then(() => console.log('Service Worker Registered'));
        }

        // --- MAP INIT ---
        const map = L.map('map', { zoomControl: false }).setView([38.514, -76.516], 15);
        const street = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        const sat = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}');

        // --- MENU LOGIC ---
        let currentTab = 'status';

        function switchTab(id) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById('tab-' + id).classList.add('active');

            document.querySelectorAll('.dt-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.mn-btn').forEach(b => b.classList.remove('active'));

            const mapIdx = { 'status': 0, 'work': 1, 'mark': 2, 'chat': 3 };
            if(document.querySelectorAll('.dt-btn')[mapIdx[id]]) document.querySelectorAll('.dt-btn')[mapIdx[id]].classList.add('active');
            if(document.querySelectorAll('.mn-btn')[mapIdx[id]]) document.querySelectorAll('.mn-btn')[mapIdx[id]].classList.add('active');

            currentTab = id;
        }

        function toggleTab(id) {
            const sidebar = document.getElementById('sidebar');
            if (currentTab === id && sidebar.classList.contains('open')) {
                sidebar.classList.remove('open');
                document.querySelectorAll('.mn-btn').forEach(b => b.classList.remove('active'));
            } else {
                switchTab(id);
                sidebar.classList.add('open');
            }
        }

        function closeMenu() {
            document.getElementById('sidebar').classList.remove('open');
            document.querySelectorAll('.mn-btn').forEach(b => b.classList.remove('active'));
        }

        // --- MARKER PLACEMENT LOGIC ---
        let placingType = null;
        function selectTool(type) {
            placingType = type;
            document.getElementById('map-overlay').style.display = 'block';
            if(window.innerWidth <= 768) closeMenu();
        }

        map.on('click', function(e) {
            if (placingType) {
                const note = prompt("Enter Note (Optional):") || placingType.toUpperCase();
                const user = document.getElementById('username').value || "Anon";
                
                db.ref('markups/').push({
                    type: placingType,
                    note: note,
                    user: user,
                    lat: e.latlng.lat,
                    lng: e.latlng.lng
                });
                placingType = null;
                document.getElementById('map-overlay').style.display = 'none';
            } else {
                if(window.innerWidth <= 768) closeMenu();
            }
        });

        // --- ADMIN ---
        let isAdmin = false;
        function toggleAdmin() {
            if(isAdmin) return; 
            const pass = prompt("Enter Password:");
            if(pass === "SCA2026") {
                isAdmin = true;
                document.getElementById('lockIcon').classList.add('unlocked');
                document.getElementById('admin-panel').style.display = 'block';
                document.getElementById('manager-task-creator').style.display = 'block';
            } else { alert("Access Denied"); }
        }
        function logoutAdmin() {
            isAdmin = false;
            document.getElementById('lockIcon').classList.remove('unlocked');
            document.getElementById('admin-panel').style.display = 'none';
            document.getElementById('manager-task-creator').style.display = 'none';
        }

        // --- ADMIN UTILS ---
        function clearMap() { if(confirm("Reset all map markups?")) db.ref('markups/').remove(); }
        function clearUnits() { if(confirm("Reset all active user locations?")) db.ref('units/').remove(); }
        function clearChat() { if(confirm("Delete chat history?")) db.ref('chat/').remove(); }
        function clearTasks() { if(confirm("Delete all tasks?")) db.ref('tasks/').remove(); }

        // --- MARKER RENDERING ---
        let markers = {};
        db.ref('markups/').on('value', snap => {
            for(let id in markers) map.removeLayer(markers[id]);
            markers = {};
            const val = snap.val();
            
            for(let id in val) {
                const m = val[id];
                let color = '#fff';
                let shapeClass = 'shape-circle';
                
                if(m.type === 'repair') { color = '#38bdf8'; shapeClass = 'shape-square'; } 
                if(m.type === 'hazard') { color = '#ef4444'; shapeClass = 'shape-diamond'; } 
                if(m.type === 'blocked') { color = '#f59e0b'; shapeClass = 'shape-circle'; } 
                
                const html = `<div class="${shapeClass}" style="border-color:${color}; background:rgba(0,0,0,0.5);"></div>`;
                const icon = L.divIcon({ className: 'empty', html: html, iconSize: [14,14], iconAnchor: [7,7] });
                
                markers[id] = L.marker([m.lat, m.lng], {icon: icon}).addTo(map)
                    .bindPopup(`<b>${m.type.toUpperCase()}</b><br>${m.note}<br><small>by ${m.user}</small>`);
            }
        });

        // --- TRACKING & UNITS ---
        let myTrackId = null;
        function toggleTracking() {
            if(myTrackId) {
                navigator.geolocation.clearWatch(myTrackId);
                myTrackId = null;
                document.getElementById('trackBtn').innerText = "START TRACKING";
                document.getElementById('gps-status').innerText = "GPS Inactive";
            } else {
                const name = document.getElementById('username').value;
                if(!name) return alert("Enter ID first");
                const role = document.getElementById('roleSelect').value;
                const colors = { blue: "#38bdf8", red: "#ef4444", green: "#22c55e", white: "#ffffff" };
                
                myTrackId = navigator.geolocation.watchPosition(pos => {
                    db.ref('units/' + name).update({
                        lat: pos.coords.latitude, lng: pos.coords.longitude,
                        color: colors[role], role: role, lastSeen: Date.now()
                    });
                    document.getElementById('trackBtn').innerText = "STOP TRACKING";
                    document.getElementById('gps-status').innerText = "Broadcasting...";
                }, null, {enableHighAccuracy:true});
            }
        }

        let unitLayers = {};
        db.ref('units/').on('value', snap => {
            for(let name in unitLayers) map.removeLayer(unitLayers[name]); // Clear old to redraw
            unitLayers = {};
            
            const units = snap.val();
            if(!units) return; // Handle empty db case
            const now = Date.now();
            
            for(let name in units) {
                const u = units[name];
                // Hide if stale > 1 hour
                if(now - u.lastSeen > 3600000) continue; 
                
                const html = `<div class="marker-pin" style="background:${u.color}"></div>`;
                const icon = L.divIcon({ className: 'empty', html: html, iconSize: [16,16], iconAnchor: [8,8] });
                
                // POPUP: Name + Role
                unitLayers[name] = L.marker([u.lat, u.lng], {icon: icon}).addTo(map)
                    .bindPopup(`<b>${name}</b><br>${u.role.toUpperCase()}`);
            }
        });

        // --- WORK TASKS ---
        function addTask() {
            const txt = document.getElementById('newTaskInput').value;
            if(txt) { db.ref('tasks/').push({ text: txt, done: false }); document.getElementById('newTaskInput').value = ""; }
        }
        db.ref('tasks/').on('value', snap => {
            const list = document.getElementById('taskList');
            list.innerHTML = "";
            snap.forEach(c => {
                const t = c.val();
                const div = document.createElement('div');
                div.style.cssText = "display:flex; justify-content:space-between; background:var(--panel); padding:10px; margin-bottom:5px; border-radius:4px;";
                if(t.done) div.style.opacity = "0.5";
                div.innerHTML = `<span style="${t.done ? 'text-decoration:line-through' : ''}">${t.text}</span> <div style="cursor:pointer;" onclick="toggleTask('${c.key}', ${t.done})">${t.done ? '‚úÖ' : '‚¨ú'}</div>`;
                list.appendChild(div);
            });
        });
        window.toggleTask = (key, stat) => { db.ref('tasks/' + key).update({ done: !stat }); };

        // --- CHAT ---
        function sendMsg() {
            const txt = document.getElementById('chatInput').value;
            const user = document.getElementById('username').value || "Anon";
            if(txt) { db.ref('chat/').push({ user, text: txt }); document.getElementById('chatInput').value = ""; }
        }
        db.ref('chat/').limitToLast(50).on('value', snap => {
            const feed = document.getElementById('chat-feed');
            feed.innerHTML = "";
            snap.forEach(c => {
                const m = c.val();
                const isMe = m.user === document.getElementById('username').value;
                const div = document.createElement('div');
                div.style.cssText = `padding:8px; margin-bottom:5px; border-radius:4px; max-width:85%; font-size:13px; ${isMe ? 'align-self:flex-end; background:var(--accent); color:black;' : 'align-self:flex-start; background:var(--panel);'}`;
                div.innerHTML = `<b>${m.user}</b>: ${m.text}`;
                feed.prepend(div);
            });
        });

        // --- UTILS ---
        function toggleSat() { map.hasLayer(sat) ? (map.removeLayer(sat), map.addLayer(street)) : (map.removeLayer(street), map.addLayer(sat)); }
        function zoomToMe() { navigator.geolocation.getCurrentPosition(p => map.setView([p.coords.latitude, p.coords.longitude], 17)); }

        // Start
        switchTab('status');
        if(window.innerWidth > 768) document.getElementById('sidebar').classList.remove('open'); 
    </script>
</body>
</html>
