<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>SCAtak | Enterprise</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --bg: #f3f4f6; --sidebar: #111827; --card: #ffffff;
            --primary: #2563eb; --accent: #0ea5e9; --success: #10b981; --warn: #f59e0b; --danger: #ef4444;
            --text-main: #1f2937; --text-light: #9ca3af; --border: #e5e7eb;
        }
        /* DARK MODE OVERRIDE FOR MAP & SIDEBAR */
        .dark-theme { --bg: #0f1115; --card: #1f2937; --text-main: #f3f4f6; --border: #374151; }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; font-family: 'Inter', system-ui, sans-serif; background: var(--bg); color: var(--text-main); height: 100vh; display: flex; overflow: hidden; }

        /* --- LAYOUTS --- */
        #desktop-sidebar {
            width: 280px; background: var(--sidebar); color: white; display: none; /* Hidden on mobile */
            flex-direction: column; z-index: 1000;
        }
        #mobile-nav {
            display: none; /* Hidden on desktop */
            position: fixed; bottom: 0; width: 100%; height: 70px; background: var(--sidebar);
            justify-content: space-around; align-items: center; z-index: 1000; padding-bottom: env(safe-area-inset-bottom);
        }
        #main-content { flex: 1; position: relative; display: flex; flex-direction: column; }

        /* RESPONSIVE BREAKPOINT */
        @media (min-width: 1024px) {
            #desktop-sidebar { display: flex; }
            #mobile-nav { display: none !important; }
        }
        @media (max-width: 1023px) {
            #desktop-sidebar { display: none; }
            #mobile-nav { display: flex; }
        }

        /* --- COMPONENTS --- */
        .logo-area { padding: 20px; font-weight: 900; font-size: 20px; letter-spacing: 1px; color: var(--primary); border-bottom: 1px solid #374151; }
        .nav-link { padding: 15px 20px; cursor: pointer; display: flex; align-items: center; gap: 10px; color: #9ca3af; transition: 0.2s; }
        .nav-link:hover, .nav-link.active { background: rgba(37, 99, 235, 0.1); color: var(--primary); border-right: 3px solid var(--primary); }
        
        /* MOBILE NAV BTNS */
        .mob-btn { color: #6b7280; display: flex; flex-direction: column; align-items: center; font-size: 10px; font-weight: 600; gap: 4px; background: none; border: none; }
        .mob-btn.active { color: var(--primary); }
        .mob-btn i { font-size: 20px; }

        /* MAP AREA */
        #map-wrapper { flex: 1; position: relative; z-index: 1; }
        #map { width: 100%; height: 100%; }

        /* INFO CARD (Property Click) */
        #prop-card {
            position: absolute; top: 20px; left: 20px; width: 300px;
            background: var(--card); padding: 20px; border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); display: none; z-index: 500;
            border-left: 5px solid var(--primary);
        }
        .prop-title { font-weight: 800; font-size: 14px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 5px; }
        .prop-address { font-size: 16px; font-weight: 600; margin-bottom: 10px; }
        .btn { width: 100%; padding: 10px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; margin-top: 5px; }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text-main); }
        .close-btn { position: absolute; top: 10px; right: 10px; cursor: pointer; color: #999; }

        /* FLOATING TOOLS */
        .fab-container { position: absolute; bottom: 90px; right: 20px; display: flex; flex-direction: column; gap: 10px; z-index: 400; }
        .fab { width: 44px; height: 44px; background: white; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 18px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); cursor: pointer; color: #333; }
        .fab:hover { background: #f9fafb; }
        .fab.active { background: var(--primary); color: white; }

        /* ADMIN DASHBOARD (Overlay) */
        #admin-dash {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #f3f4f6; z-index: 600; padding: 20px; overflow-y: auto; display: none;
        }
        .dash-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .stat-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .table-wrap { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #eee; font-size: 14px; }
        th { background: #f9fafb; font-weight: 600; color: #6b7280; font-size: 12px; text-transform: uppercase; }

        /* LEAFLET HACKS */
        .leaflet-routing-container { display: none !important; }

        /* LOCK SCREEN */
        #lock-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #111827; z-index: 9999; display: flex; flex-direction: column;
            align-items: center; justify-content: center; color: white;
        }
    </style>
</head>
<body>

    <div id="lock-screen">
        <h1 style="letter-spacing: 2px;">SCAtak</h1>
        <p style="color:#6b7280; margin-bottom:20px;">ENTER ACCESS CODE</p>
        <input type="password" id="pinInput" style="padding:10px; font-size:20px; letter-spacing:5px; text-align:center; border-radius:6px; border:none;" maxlength="7">
    </div>

    <div id="desktop-sidebar">
        <div class="logo-area">SCAtak ADMIN</div>
        <div class="nav-link active" onclick="showMap()"><i class="fa-solid fa-map"></i> LIVE MAP</div>
        <div class="nav-link" onclick="showDash()"><i class="fa-solid fa-chart-line"></i> DASHBOARD</div>
        <div class="nav-link" onclick="showAssets()"><i class="fa-solid fa-box"></i> ASSETS</div>
        <div class="nav-link" onclick="logout()"><i class="fa-solid fa-right-from-bracket"></i> LOGOUT</div>
    </div>

    <div id="main-content">
        
        <div id="map-wrapper">
            <div id="map"></div>
            
            <div id="prop-card">
                <div class="close-btn" onclick="closeCard()">Ã—</div>
                <div class="prop-title">PROPERTY RECORD</div>
                <div class="prop-address" id="propAddr">Loading...</div>
                <div style="display:flex; gap:10px;">
                    <button class="btn" onclick="routeToProp()"><i class="fa-solid fa-route"></i> ROUTE</button>
                    <button class="btn btn-outline" onclick="saveWaypoint()"><i class="fa-solid fa-star"></i> SAVE</button>
                </div>
                <div style="margin-top:10px; font-size:12px; color:#666;">
                    <strong>COORDS:</strong> <span id="propCoords"></span>
                </div>
            </div>

            <div class="fab-container">
                <div class="fab" title="Measure Area" onclick="toggleMeasure()"><i class="fa-solid fa-draw-polygon"></i></div>
                <div class="fab" title="Satellite View" onclick="toggleSat()"><i class="fa-solid fa-layer-group"></i></div>
                <div class="fab" title="Locate Me" onclick="locateMe()"><i class="fa-solid fa-crosshairs"></i></div>
            </div>
        </div>

        <div id="admin-dash">
            <h2 style="margin-bottom:20px; color:#1f2937;">COMMAND OVERVIEW</h2>
            
            <div class="dash-grid">
                <div class="stat-card">
                    <div style="color:#6b7280; font-size:12px; font-weight:bold;">ACTIVE UNITS</div>
                    <div style="font-size:32px; font-weight:800; color:#2563eb;" id="unitCount">0</div>
                </div>
                <div class="stat-card">
                    <div style="color:#6b7280; font-size:12px; font-weight:bold;">OPEN TICKETS</div>
                    <div style="font-size:32px; font-weight:800; color:#f59e0b;">3</div>
                </div>
                <div class="stat-card">
                    <div style="color:#6b7280; font-size:12px; font-weight:bold;">SYSTEM STATUS</div>
                    <div style="font-size:16px; font-weight:800; color:#10b981; margin-top:10px;">ONLINE / NORMAL</div>
                </div>
            </div>

            <h3 style="margin:20px 0;">ACTIVE PERSONNEL</h3>
            <div class="table-wrap">
                <table id="unitTable">
                    <thead><tr><th>UNIT ID</th><th>ROLE</th><th>LAST SEEN</th><th>BATTERY</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

    </div>

    <div id="mobile-nav">
        <button class="mob-btn active" onclick="showMap()"><i class="fa-solid fa-map-location-dot"></i> MAP</button>
        <button class="mob-btn" onclick="alert('TASK LIST OPEN')"><i class="fa-solid fa-clipboard-list"></i> TASKS</button>
        <button class="mob-btn" onclick="alert('ASSET LIST OPEN')"><i class="fa-solid fa-toolbox"></i> GEAR</button>
        <button class="mob-btn" onclick="alert('CHAT OPEN')"><i class="fa-solid fa-comments"></i> CHAT</button>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <script>
        // --- 1. CONFIG & AUTH ---
        const firebaseConfig = {
            apiKey: "AIzaSyCZkpLZt-r5e5B-KWBJiiGHMaHY3get6rM",
            authDomain: "sca-tak.firebaseapp.com",
            projectId: "sca-tak",
            storageBucket: "sca-tak.firebasestorage.app",
            messagingSenderId: "1073161858259",
            appId: "1:1073161858259:web:a860ae211ff3d32e1a7826",
            databaseURL: "https://sca-tak-default-rtdb.firebaseio.com"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // LOCK SCREEN
        document.getElementById('pinInput').addEventListener('keyup', (e) => {
            if(e.target.value === "SCA2026") {
                document.getElementById('lock-screen').style.display = 'none';
                initApp();
            }
        });

        // --- 2. MAP SYSTEM ---
        let map, satLayer, routingControl;
        let selectedCoords = null;
        let measurePoints = [];
        let measurePoly = null;
        let isMeasuring = false;

        function initApp() {
            // Init Map (OpenStreetMap Standard for clean look)
            map = L.map('map', {zoomControl: false}).setView([38.515, -76.513], 15);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            
            satLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}');

            // --- CLICK TO IDENTIFY PROPERTY ---
            map.on('click', async function(e) {
                if(isMeasuring) {
                    addMeasurePoint(e.latlng);
                    return;
                }

                // 1. Show Loading
                const card = document.getElementById('prop-card');
                card.style.display = 'block';
                document.getElementById('propAddr').innerText = "Fetching Address...";
                document.getElementById('propCoords').innerText = e.latlng.lat.toFixed(5) + ", " + e.latlng.lng.toFixed(5);
                selectedCoords = e.latlng;

                // 2. Reverse Geocode (Nominatim API)
                try {
                    const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${e.latlng.lat}&lon=${e.latlng.lng}`);
                    const data = await res.json();
                    
                    // Format Address
                    let addr = data.address.house_number ? `${data.address.house_number} ` : "";
                    addr += data.address.road || "Unknown Road";
                    document.getElementById('propAddr').innerText = addr;
                } catch(err) {
                    document.getElementById('propAddr').innerText = "Location Info Unavailable";
                }
            });

            // Start User Tracking
            trackUser();
        }

        // --- 3. ROUTING ENGINE ---
        function routeToProp() {
            if(!selectedCoords) return;
            
            navigator.geolocation.getCurrentPosition(pos => {
                if(routingControl) map.removeControl(routingControl);
                
                routingControl = L.Routing.control({
                    waypoints: [
                        L.latLng(pos.coords.latitude, pos.coords.longitude),
                        selectedCoords
                    ],
                    lineOptions: { styles: [{color: '#a855f7', opacity: 0.8, weight: 6}] }, // Purple Line
                    createMarker: function() { return null; },
                    show: false // No text box
                }).addTo(map);

                // Close card to see map
                closeCard();
            });
        }

        // --- 4. MEASURE TOOL ---
        function toggleMeasure() {
            isMeasuring = !isMeasuring;
            if(isMeasuring) {
                alert("Tap points on map to measure area. Tap FAB again to clear.");
                measurePoints = [];
            } else {
                if(measurePoly) map.removeLayer(measurePoly);
                measurePoints = [];
            }
        }

        function addMeasurePoint(latlng) {
            measurePoints.push(latlng);
            if(measurePoly) map.removeLayer(measurePoly);
            
            // Draw Polygon
            measurePoly = L.polygon(measurePoints, {color: '#f59e0b'}).addTo(map);

            // Calculate Area (Simple approx)
            if(measurePoints.length > 2) {
                // (Geodesic area calc omitted for brevity, keeping it visual for now)
                // Real implementation requires Leaflet.GeometryUtil
            }
        }

        // --- 5. ADMIN DATA ---
        db.ref('units').on('value', snap => {
            const units = snap.val() || {};
            const tbody = document.querySelector('#unitTable tbody');
            tbody.innerHTML = "";
            document.getElementById('unitCount').innerText = Object.keys(units).length;

            // Update Table
            for(let key in units) {
                const u = units[key];
                const row = `<tr>
                    <td><strong>${key}</strong></td>
                    <td><span style="background:#e0f2fe; color:#0369a1; padding:2px 8px; border-radius:10px; font-size:10px; font-weight:bold;">${u.role || 'UNIT'}</span></td>
                    <td>${new Date(u.lastSeen).toLocaleTimeString()}</td>
                    <td>${u.batt ? u.batt+'%' : '--'}</td>
                </tr>`;
                tbody.innerHTML += row;

                // Update Map Markers
                // (Map marker logic reused from v50)
            }
        });

        // --- 6. UTILS ---
        function trackUser() {
            const u = localStorage.getItem('sca_user') || "Admin";
            navigator.geolocation.watchPosition(pos => {
                db.ref('units/'+u).update({
                    lat: pos.coords.latitude, lng: pos.coords.longitude,
                    batt: 100, // Mock
                    lastSeen: Date.now()
                });
            });
        }

        function toggleSat() {
            if(map.hasLayer(satLayer)) map.removeLayer(satLayer);
            else map.addLayer(satLayer);
        }
        function locateMe() {
            navigator.geolocation.getCurrentPosition(p => map.setView([p.coords.latitude, p.coords.longitude], 17));
        }
        function showMap() { document.getElementById('admin-dash').style.display = 'none'; }
        function showDash() { document.getElementById('admin-dash').style.display = 'block'; }
        function closeCard() { document.getElementById('prop-card').style.display = 'none'; }
        function saveWaypoint() { alert("Saved to Database"); }
        function logout() { location.reload(); }

    </script>
</body>
</html>
