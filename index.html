<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>SCA Workforce</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    
    <style>
        /* DARK WORKFORCE THEME */
        :root { --bg: #0f172a; --panel: #1e293b; --accent: #38bdf8; --border: #334155; --text: #f1f5f9; --danger: #ef4444; --success: #22c55e; }
        
        body { margin: 0; padding: 0; background: #000; height: 100dvh; display: flex; justify-content: center; font-family: 'Inter', sans-serif; color: var(--text); overflow: hidden; }

        #app-shell { width: 100%; max-width: 550px; height: 100%; position: relative; background: var(--bg); display: flex; flex-direction: column; box-shadow: 0 0 50px rgba(0,0,0,0.5); }
        
        /* HEADER & ADMIN LOCK */
        .app-header { position: absolute; top: 0; left: 0; width: 100%; height: 60px; z-index: 1000; pointer-events: none; display: flex; justify-content: space-between; padding: 10px; box-sizing: border-box; }
        .admin-lock { pointer-events: auto; opacity: 0.3; font-size: 18px; cursor: pointer; padding: 10px; }
        .admin-lock.unlocked { opacity: 1; color: var(--success); }

        /* MAP */
        #map { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; }

        /* BOTTOM SHEET */
        .sheet {
            position: absolute; bottom: 70px; left: 10px; right: 10px;
            background: rgba(30,41,59, 0.98); backdrop-filter: blur(12px);
            border-radius: 16px; border: 1px solid var(--border);
            height: 0; transition: height 0.25s cubic-bezier(0.25, 0.8, 0.25, 1);
            overflow: hidden; z-index: 20; display: flex; flex-direction: column;
        }
        .sheet.open { height: 65%; box-shadow: 0 -10px 40px rgba(0,0,0,0.5); }
        
        .sheet-header { padding: 15px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.2); }
        .sheet-title { font-weight: 800; font-size: 14px; text-transform: uppercase; letter-spacing: 1px; color: var(--accent); }
        .sheet-content { padding: 20px; overflow-y: auto; flex: 1; }

        /* NAV BAR */
        .nav-bar { position: absolute; bottom: 0; left: 0; width: 100%; height: 70px; background: #0f172a; border-top: 1px solid var(--border); display: flex; justify-content: space-around; align-items: center; z-index: 30; padding-bottom: env(safe-area-inset-bottom); }
        .nav-item { background: none; border: none; color: #64748b; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 4px; font-size: 10px; font-weight: 600; width: 25%; }
        .nav-item.active { color: var(--accent); }
        .nav-icon { font-size: 20px; }

        /* COMPONENTS */
        .btn { width: 100%; padding: 14px; border: none; border-radius: 8px; font-weight: bold; font-size: 14px; margin-bottom: 10px; cursor: pointer; color: white; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-blue { background: var(--accent); color: #0f172a; }
        .btn-red { background: var(--danger); }
        .btn-dark { background: #334155; }
        
        .input-dark { width: 100%; padding: 12px; background: #0f172a; border: 1px solid #334155; color: white; border-radius: 8px; margin-bottom: 10px; box-sizing: border-box; font-size: 16px; }

        /* TASK LIST */
        .task-card { background: #0f172a; border: 1px solid var(--border); padding: 12px; border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
        .task-card.done { opacity: 0.5; }
        .task-card.done span { text-decoration: line-through; }
        .chk-box { width: 24px; height: 24px; border: 2px solid var(--border); border-radius: 6px; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .chk-box.checked { background: var(--success); border-color: var(--success); }

        /* ADMIN TOOLS SECTION */
        .admin-panel { border: 1px solid var(--danger); padding: 10px; border-radius: 8px; margin-top: 20px; background: rgba(239, 68, 68, 0.1); display: none; }
        .admin-panel.visible { display: block; }
        
        /* MAP ICONS */
        .pulse-marker { width: 14px; height: 14px; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 10px currentColor; background: currentColor; }
        .note-marker { background: #fef08a; color: black; padding: 4px 8px; border-radius: 4px; font-weight: bold; font-size: 11px; border: 1px solid black; white-space: nowrap; box-shadow: 0 2px 5px rgba(0,0,0,0.5); }
    </style>
</head>
<body>

<div id="app-shell">
    
    <div class="app-header">
        <div class="admin-lock" id="adminLock" onclick="unlockAdmin()">üîí</div>
    </div>

    <div id="map"></div>

    <div id="sheet" class="sheet">
        <div class="sheet-header">
            <div id="sheetTitle" class="sheet-title">Menu</div>
            <div style="font-size:24px; cursor:pointer;" onclick="closeSheet()">√ó</div>
        </div>
        
        <div id="view-status" class="sheet-content hidden">
            <input type="text" id="username" class="input-dark" placeholder="Name / Unit ID">
            <select id="roleSelect" class="input-dark">
                <option value="blue">üîµ Employee</option>
                <option value="green">üü¢ Admin / Manager</option>
                <option value="white">‚ö™ Volunteer</option>
            </select>
            <button class="btn btn-blue" onclick="goOnline()">üì° GO ONLINE</button>
            
            <div id="adminControls" class="admin-panel">
                <div style="color:var(--danger); font-weight:bold; margin-bottom:10px; text-align:center;">‚ö†Ô∏è MANAGER TOOLS</div>
                <button class="btn btn-red" onclick="clearMap()">üóëÔ∏è CLEAR ALL MAP MARKS</button>
                <button class="btn btn-red" onclick="clearChat()">üî• NUKE CHAT HISTORY</button>
            </div>
        </div>

        <div id="view-work" class="sheet-content hidden">
            <div id="managerTaskInput" style="display:none; margin-bottom:15px; border-bottom:1px solid #333; padding-bottom:10px;">
                <input type="text" id="newTaskInput" class="input-dark" placeholder="Assign new work...">
                <button class="btn btn-blue" onclick="addTask()">+ ASSIGN TASK</button>
            </div>

            <div id="taskList"></div>
            <div style="text-align:center; color:#666; font-size:12px; margin-top:20px;">Only Managers can assign work.</div>
        </div>

        <div id="view-mark" class="sheet-content hidden">
            <div style="color:#94a3b8; font-size:13px; margin-bottom:15px; text-align:center;">
                Drop a note at your current location for the team.
            </div>
            <input type="text" id="noteInput" class="input-dark" placeholder="e.g., 'Broken Pipe' or 'Staging Area'">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <button class="btn btn-dark" onclick="dropNote('‚ö†Ô∏è')">‚ö†Ô∏è HAZARD</button>
                <button class="btn btn-dark" onclick="dropNote('üõ†Ô∏è')">üõ†Ô∏è REPAIR</button>
                <button class="btn btn-dark" onclick="dropNote('üö´')">üö´ BLOCKED</button>
                <button class="btn btn-dark" onclick="dropNote('üìç')">üìç NOTE</button>
            </div>
        </div>

        <div id="view-chat" class="sheet-content hidden">
            <div id="chatList" style="height: 250px; overflow-y: auto; display: flex; flex-direction: column-reverse; margin-bottom: 15px;"></div>
            <div style="display: flex; gap: 10px;">
                <input type="text" id="chatInput" class="input-dark" style="margin:0" placeholder="Team message...">
                <button onclick="sendMsg()" class="btn btn-blue" style="width: auto; margin:0;">Send</button>
            </div>
        </div>
    </div>

    <div class="nav-bar">
        <button class="nav-item active" onclick="openTab('status')"><span class="nav-icon">üë§</span>ID</button>
        <button class="nav-item" onclick="openTab('work')"><span class="nav-icon">üìã</span>WORK</button>
        <button class="nav-item" onclick="openTab('mark')"><span class="nav-icon">‚úèÔ∏è</span>MARK</button>
        <button class="nav-item" onclick="openTab('chat')"><span class="nav-icon">üí¨</span>CHAT</button>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
    // --- CONFIG ---
    const firebaseConfig = {
        apiKey: "AIzaSyCZkpLZt-r5e5B-KWBJiiGHMaHY3get6rM",
        authDomain: "sca-tak.firebaseapp.com",
        projectId: "sca-tak",
        storageBucket: "sca-tak.firebasestorage.app",
        messagingSenderId: "1073161858259",
        appId: "1:1073161858259:web:a860ae211ff3d32e1a7826",
        databaseURL: "https://sca-tak-default-rtdb.firebaseio.com"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // --- MAP ---
    const map = L.map('map', { zoomControl: false }).setView([38.514, -76.516], 15);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    let isAdmin = false;

    // --- ADMIN LOGIC ---
    function unlockAdmin() {
        const pass = prompt("Enter Supervisor Password:");
        if(pass === "SCA2026") {
            isAdmin = true;
            document.getElementById('adminLock').classList.add('unlocked');
            document.getElementById('adminControls').classList.add('visible');
            document.getElementById('managerTaskInput').style.display = 'block'; // Show task creator
            alert("Supervisor Mode: UNLOCKED");
        } else {
            alert("Access Denied");
        }
    }

    function clearMap() {
        if(confirm("Delete all map markups? This cannot be undone.")) {
            db.ref('markups/').remove();
        }
    }

    function clearChat() {
        if(confirm("Delete all chat history?")) {
            db.ref('chat/').remove();
        }
    }

    // --- NAVIGATION ---
    function openTab(id) {
        document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
        event.currentTarget.classList.add('active');
        document.querySelectorAll('.sheet-content').forEach(c => c.classList.add('hidden'));
        document.getElementById('view-' + id).classList.remove('hidden');
        document.getElementById('sheetTitle').innerText = id.toUpperCase();
        document.getElementById('sheet').classList.add('open');
    }
    function closeSheet() { document.getElementById('sheet').classList.remove('open'); }
    map.on('click', closeSheet);

    // --- TRACKING ---
    function goOnline() {
        const name = document.getElementById('username').value;
        const role = document.getElementById('roleSelect').value;
        if(!name) return alert("Enter Name");
        const colors = { blue: "#38bdf8", green: "#22c55e", white: "#ffffff" };

        if(navigator.geolocation) {
            navigator.geolocation.watchPosition(pos => {
                db.ref('units/' + name).update({
                    lat: pos.coords.latitude, lng: pos.coords.longitude,
                    color: colors[role], role: role, lastSeen: Date.now()
                });
                closeSheet();
            }, null, { enableHighAccuracy: true });
        }
    }

    // --- RENDER UNITS ---
    let markers = {};
    db.ref('units/').on('value', snap => {
        const units = snap.val();
        if(!units) return;
        const now = Date.now();
        for(let name in units) {
            const u = units[name];
            if(now - u.lastSeen > 3600000) { if(markers[name]) map.removeLayer(markers[name]); continue; }
            
            if(markers[name]) map.removeLayer(markers[name]);
            const html = `<div style="position:relative; color:${u.color};"><div class="pulse-marker"></div></div>`;
            const icon = L.divIcon({ className: 'empty', html: html, iconSize: [14,14], iconAnchor: [7,7] });
            markers[name] = L.marker([u.lat, u.lng], {icon: icon}).addTo(map).bindPopup(name);
        }
    });

    // --- MAP MARKUP (Shared Notes) ---
    function dropNote(icon) {
        const note = document.getElementById('noteInput').value || "Mark";
        const user = document.getElementById('username').value || "Anon";
        navigator.geolocation.getCurrentPosition(pos => {
            db.ref('markups/').push({
                icon: icon, note: note, user: user,
                lat: pos.coords.latitude, lng: pos.coords.longitude
            });
            closeSheet();
            document.getElementById('noteInput').value = "";
        });
    }

    let noteLayers = {};
    db.ref('markups/').on('value', snap => {
        // Clear old notes visually (simple refresh)
        for(let id in noteLayers) map.removeLayer(noteLayers[id]);
        noteLayers = {};

        const marks = snap.val();
        for(let id in marks) {
            const m = marks[id];
            const html = `<div class="note-marker">${m.icon} ${m.note}</div>`;
            const icon = L.divIcon({ className: 'empty', html: html, iconSize: [null, null], iconAnchor: [20, 10] });
            noteLayers[id] = L.marker([m.lat, m.lng], {icon: icon}).addTo(map);
        }
    });

    // --- WORK TASKS ---
    function addTask() {
        const txt = document.getElementById('newTaskInput').value;
        if(txt) { db.ref('tasks/').push({ text: txt, done: false }); document.getElementById('newTaskInput').value = ""; }
    }

    db.ref('tasks/').on('value', snap => {
        const list = document.getElementById('taskList');
        list.innerHTML = "";
        snap.forEach(child => {
            const t = child.val();
            const div = document.createElement('div');
            div.className = `task-card ${t.done ? 'done' : ''}`;
            div.innerHTML = `<span>${t.text}</span> <div class="chk-box ${t.done ? 'checked' : ''}" onclick="toggleTask('${child.key}', ${t.done})">‚úì</div>`;
            list.appendChild(div);
        });
    });

    window.toggleTask = (key, status) => { db.ref('tasks/' + key).update({ done: !status }); };

    // --- CHAT ---
    function sendMsg() {
        const txt = document.getElementById('chatInput').value;
        const user = document.getElementById('username').value || "Anon";
        if(txt) { db.ref('chat/').push({ user, text: txt }); document.getElementById('chatInput').value = ""; }
    }
    db.ref('chat/').limitToLast(50).on('value', snap => {
        const list = document.getElementById('chatList');
        list.innerHTML = ""; 
        snap.forEach(c => {
            const m = c.val();
            const div = document.createElement('div');
            div.style.padding="8px"; div.style.marginBottom="5px"; div.style.background="#334155"; div.style.borderRadius="6px";
            div.innerHTML = `<b>${m.user}:</b> ${m.text}`;
            list.prepend(div);
        });
    });

    // Start on Status
    openTab('status');
</script>
</body>
</html>
