<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>SCAtak | Calvert County</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        :root { --primary: #1a73e8; --bg: #f8f9fa; --accent: #34a853; }
        body { font-family: -apple-system, system-ui, sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; background: var(--bg); }
        
        #map { flex: 1; width: 100%; z-index: 1; }

        .dashboard { 
            height: 45vh; background: white; border-top: 4px solid var(--primary);
            display: flex; flex-direction: column; z-index: 1000;
            box-shadow: 0 -5px 15px rgba(0,0,0,0.15); border-radius: 20px 20px 0 0;
        }

        .tabs { display: flex; border-bottom: 1px solid #ddd; }
        .tab { flex: 1; padding: 15px; text-align: center; cursor: pointer; font-weight: bold; color: #555; transition: 0.3s; }
        .tab.active { color: var(--primary); border-bottom: 3px solid var(--primary); }

        .content-area { flex: 1; overflow-y: auto; padding: 15px; }
        .hidden { display: none; }

        input, select, textarea { width: 100%; padding: 12px; margin: 5px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        .btn { background: var(--primary); color: white; border: none; padding: 14px; width: 100%; border-radius: 8px; font-weight: bold; margin-top: 10px; cursor: pointer; }
        
        .locate-btn { position: absolute; top: 10px; right: 10px; z-index: 500; background: white; border: 2px solid rgba(0,0,0,0.2); border-radius: 4px; padding: 8px; cursor: pointer; font-weight: bold; }

        .msg-card { background: #eef2f7; padding: 12px; border-radius: 10px; margin-bottom: 10px; border-left: 5px solid var(--primary); }
        .msg-meta { font-size: 0.75rem; color: #666; margin-bottom: 4px; }
        
        .header-brand { position: absolute; top: 10px; left: 50px; z-index: 500; background: rgba(255,255,255,0.9); padding: 5px 15px; border-radius: 20px; font-weight: bold; color: var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    </style>
</head>
<body>

    <div class="header-brand">SCAtak</div>
    <button class="locate-btn" onclick="zoomToMe()">üìç Center Me</button>
    <div id="map"></div>

    <div class="dashboard">
        <div class="tabs">
            <div id="tab-status" class="tab active" onclick="showTab('status')">MY STATUS</div>
            <div id="tab-board" class="tab" onclick="showTab('board')">TEAM BOARD</div>
        </div>

        <div id="status-tab" class="content-area">
            <input type="text" id="username" placeholder="Employee Name/Unit">
            <select id="userColor">
                <option value="#2563eb">Blue (Field)</option>
                <option value="#dc2626">Red (Urgent)</option>
                <option value="#16a34a">Green (Available)</option>
                <option value="#9333ea">Purple (Manager)</option>
            </select>
            <select id="userStatus">
                <option value="Active">Active</option>
                <option value="En-Route">En-Route</option>
                <option value="On-Site">On-Site</option>
                <option value="Busy">Busy</option>
            </select>
            <input type="text" id="currentTask" placeholder="Current Tasking...">
            <button class="btn" onclick="updateCloud()">SCAtak SYNC</button>
        </div>

        <div id="board-tab" class="content-area hidden">
            <textarea id="boardInput" placeholder="New tasking or update..."></textarea>
            <button class="btn" style="background: var(--accent);" onclick="postMessage()">POST TO SCAtak</button>
            <div id="messageList" style="margin-top: 15px;"></div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <script>
        // --- SCAtak FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyCZkpLZt-r5e5B-KWBJiiGHMaHY3get6rM",
            authDomain: "sca-tak.firebaseapp.com",
            projectId: "sca-tak",
            storageBucket: "sca-tak.firebasestorage.app",
            messagingSenderId: "1073161858259",
            appId: "1:1073161858259:web:a860ae211ff3d32e1a7826",
            databaseURL: "https://sca-tak-default-rtdb.firebaseio.com"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // --- MAP SETUP (CALVERT COUNTY) ---
        const southWest = L.latLng(38.309, -76.750);
        const northEast = L.latLng(38.780, -76.450);
        const bounds = L.latLngBounds(southWest, northEast);

        const map = L.map('map', {
            maxBounds: bounds,
            maxBoundsViscosity: 1.0
        }).setView([38.548, -76.584], 11); 

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        let userMarkers = {};

        function showTab(tabName) {
            document.getElementById('status-tab').classList.toggle('hidden', tabName !== 'status');
            document.getElementById('board-tab').classList.toggle('hidden', tabName !== 'board');
            document.getElementById('tab-status').classList.toggle('active', tabName === 'status');
            document.getElementById('tab-board').classList.toggle('active', tabName === 'board');
        }

        function zoomToMe() {
            navigator.geolocation.getCurrentPosition(pos => {
                map.setView([pos.coords.latitude, pos.coords.longitude], 14);
            });
        }

        function updateCloud() {
            const name = document.getElementById('username').value;
            if(!name) return alert("Please enter your name.");

            navigator.geolocation.getCurrentPosition((pos) => {
                db.ref('employees/' + name).set({
                    lat: pos.coords.latitude,
                    lng: pos.coords.longitude,
                    color: document.getElementById('userColor').value,
                    status: document.getElementById('userStatus').value,
                    task: document.getElementById('currentTask').value,
                    time: new Date().toLocaleTimeString()
                });
                alert("SCAtak Synced Successfully!");
            });
        }

        db.ref('employees/').on('value', (snapshot) => {
            const data = snapshot.val();
            for (let id in data) { renderMarker(id, data[id]); }
        });

        function renderMarker(name, data) {
            if (userMarkers[name]) map.removeLayer(userMarkers[name]);
            const iconHtml = `<div style="background-color:${data.color}; width:20px; height:20px; border-radius:50%; border:2px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.5);"></div>`;
            const customIcon = L.divIcon({ html: iconHtml, className: 'custom-pin', iconSize: [20, 20] });
            userMarkers[name] = L.marker([data.lat, data.lng], {icon: customIcon}).addTo(map)
                .bindPopup(`<b>${name}</b><br>${data.status}<br>${data.task}`);
        }

        function postMessage() {
            const text = document.getElementById('boardInput').value;
            const user = document.getElementById('username').value || 'User';
            if(!text) return;
            db.ref('messages/').push({ user, text, time: new Date().toLocaleTimeString() });
            document.getElementById('boardInput').value = "";
        }

        db.ref('messages/').limitToLast(15).on('child_added', (snapshot) => {
            const msg = snapshot.val();
            const list = document.getElementById('messageList');
            const card = `<div class="msg-card"><div class="msg-meta"><strong>${msg.user}</strong> ‚Ä¢ ${msg.time}</div><div>${msg.text}</div></div>`;
            list.insertAdjacentHTML('afterbegin', card);
        });
    </script>
</body>
</html>