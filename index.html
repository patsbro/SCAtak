<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="SCAtak">
    <link rel="manifest" href="manifest.json">
    <title>SCAtak Ultimate</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --glass: rgba(16, 20, 24, 0.85);
            --glass-border: rgba(255, 255, 255, 0.1);
            --accent: #00f0ff; /* Cyber Cyan */
            --danger: #ff2a6d; /* Neon Red */
            --success: #05ffa1; /* Neon Green */
            --text: #e0fbfc;
            --safe-bottom: env(safe-area-inset-bottom);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        
        body { 
            margin: 0; background: #000; color: var(--text); 
            font-family: 'Inter', sans-serif; overflow: hidden; height: 100dvh; 
            display: flex; flex-direction: column;
        }

        /* --- MAP LAYER --- */
        #map { flex: 1; width: 100%; height: 100%; z-index: 0; background: #0b0d12; }
        .night-vision { filter: grayscale(100%) sepia(100%) hue-rotate(-50deg) saturate(300%) contrast(1.2); }

        /* --- HUD ELEMENTS --- */
        .hud-top {
            position: absolute; top: 0; left: 0; width: 100%; 
            background: linear-gradient(180deg, rgba(0,0,0,0.9) 0%, transparent 100%);
            z-index: 10; padding-top: env(safe-area-inset-top); pointer-events: none;
        }

        .marquee-container {
            background: rgba(255, 42, 109, 0.2); border-bottom: 1px solid var(--danger);
            overflow: hidden; white-space: nowrap; height: 24px; display: flex; align-items: center;
            pointer-events: auto;
        }
        .marquee-text {
            animation: scroll 15s linear infinite; font-family: 'Rajdhani', sans-serif; 
            font-weight: 700; color: var(--danger); font-size: 14px; text-transform: uppercase;
            padding-left: 100%;
        }
        @keyframes scroll { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }

        .weather-widget {
            position: absolute; top: 35px; right: 15px; text-align: right;
            font-family: 'Rajdhani', sans-serif; text-shadow: 0 0 5px black; pointer-events: auto;
        }
        .weather-temp { font-size: 28px; font-weight: 700; color: var(--accent); line-height: 1; }
        .weather-detail { font-size: 12px; color: #aaa; font-weight: 600; }

        .speed-widget {
            position: absolute; top: 35px; left: 15px; 
            font-family: 'Rajdhani', sans-serif; text-shadow: 0 0 5px black;
        }
        .speed-val { font-size: 28px; font-weight: 700; color: var(--success); line-height: 1; }
        .speed-label { font-size: 10px; color: #aaa; letter-spacing: 1px; }

        /* --- FLOATING CONTROLS (Right Side) --- */
        .fab-container {
            position: absolute; bottom: calc(85px + var(--safe-bottom)); right: 15px;
            display: flex; flex-direction: column; gap: 12px; z-index: 20;
        }
        .fab {
            width: 48px; height: 48px; border-radius: 12px;
            background: var(--glass); border: 1px solid var(--glass-border);
            color: var(--accent); display: flex; align-items: center; justify-content: center;
            font-size: 20px; backdrop-filter: blur(10px); cursor: pointer;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37); transition: 0.2s;
        }
        .fab:active { transform: scale(0.9); background: var(--accent); color: black; }
        .fab.sos { border-color: var(--danger); color: var(--danger); }
        .fab.sos.active { background: var(--danger); color: white; animation: pulse 1s infinite; }

        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255, 42, 109, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(255, 42, 109, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 42, 109, 0); } }

        /* --- BOTTOM NAVIGATION (Glass) --- */
        .nav-bar {
            position: absolute; bottom: 0; left: 0; width: 100%;
            height: calc(75px + var(--safe-bottom));
            background: var(--glass); border-top: 1px solid var(--glass-border);
            backdrop-filter: blur(15px);
            display: flex; justify-content: space-around; align-items: flex-start;
            z-index: 100; padding-top: 10px; padding-bottom: var(--safe-bottom);
        }
        
        .nav-item {
            background: none; border: none; color: #64748b;
            display: flex; flex-direction: column; align-items: center; gap: 4px;
            font-size: 10px; font-weight: 600; width: 20%; cursor: pointer;
        }
        .nav-item svg { width: 24px; height: 24px; fill: currentColor; transition: 0.3s; }
        .nav-item.active { color: var(--accent); }
        .nav-item.active svg { filter: drop-shadow(0 0 5px var(--accent)); transform: translateY(-3px); }

        /* --- SLIDE-UP PANELS --- */
        .panel {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 0;
            background: #111418; z-index: 90; overflow: hidden;
            transition: height 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border-top-left-radius: 24px; border-top-right-radius: 24px;
            border-top: 1px solid var(--glass-border);
            padding-bottom: calc(80px + var(--safe-bottom)); /* Clear nav */
        }
        .panel.open { height: 75vh; }
        .panel-content { padding: 25px; height: 100%; overflow-y: auto; }
        
        h2 { margin: 0 0 20px 0; font-family: 'Rajdhani'; text-transform: uppercase; color: var(--accent); border-bottom: 1px solid #333; padding-bottom: 10px; display: flex; justify-content: space-between; }
        
        /* UI COMPONENTS */
        .btn { width: 100%; padding: 16px; border-radius: 12px; border: none; font-weight: 700; margin-bottom: 12px; font-size: 14px; cursor: pointer; text-transform: uppercase; letter-spacing: 1px; font-family: 'Rajdhani'; }
        .btn-cyan { background: rgba(0, 240, 255, 0.15); border: 1px solid var(--accent); color: var(--accent); }
        .btn-red { background: rgba(255, 42, 109, 0.15); border: 1px solid var(--danger); color: var(--danger); }
        .btn-green { background: rgba(5, 255, 161, 0.15); border: 1px solid var(--success); color: var(--success); }
        
        .input-cyber {
            width: 100%; padding: 14px; background: #000; border: 1px solid #333; 
            color: white; border-radius: 8px; margin-bottom: 15px; font-family: 'Inter';
        }
        .input-cyber:focus { border-color: var(--accent); outline: none; box-shadow: 0 0 10px rgba(0, 240, 255, 0.2); }

        /* LIST ITEMS */
        .list-item { background: #1a1e24; padding: 15px; border-radius: 8px; margin-bottom: 8px; border-left: 3px solid #444; display: flex; justify-content: space-between; align-items: center; }
        .list-item.done { opacity: 0.5; border-left-color: var(--success); }

        /* FLASHLIGHT OVERLAY */
        #torch-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white; z-index: 9999; display: none;
        }

    </style>
</head>
<body>

    <div id="torch-overlay" onclick="toggleTorch()"></div>

    <div class="hud-top">
        <div class="marquee-container" id="marqueeBox" style="display:none;">
            <div class="marquee-text" id="marqueeText">‚ö†Ô∏è SEVERE WEATHER WARNING IN EFFECT FOR CALVERT COUNTY ‚ö†Ô∏è</div>
        </div>
        
        <div class="speed-widget">
            <div class="speed-val" id="speedVal">0</div>
            <div class="speed-label">MPH <span id="compassVal">N</span></div>
        </div>

        <div class="weather-widget">
            <div class="weather-temp" id="weatherTemp">--¬∞</div>
            <div class="weather-detail" id="weatherWind">-- mph</div>
        </div>
    </div>

    <div id="map"></div>

    <div class="fab-container">
        <div class="fab" onclick="toggleNightMode()">üåë</div>
        <div class="fab" onclick="toggleTorch()">üî¶</div>
        <div class="fab" onclick="zoomToSCA()">üèòÔ∏è</div>
        <div class="fab" onclick="locateMe()">üéØ</div>
        <div class="fab sos" id="sosBtn" onmousedown="startSOS()" onmouseup="endSOS()" ontouchstart="startSOS()" ontouchend="endSOS()">üÜò</div>
    </div>

    <div id="panel-id" class="panel">
        <div class="panel-content">
            <h2>Identity & Status <span id="lockIcon" onclick="toggleAdmin()">üîí</span></h2>
            
            <div id="admin-tools" style="display:none; margin-bottom:20px; border:1px solid var(--danger); padding:10px; border-radius:8px;">
                <div style="color:var(--danger); font-size:10px; margin-bottom:10px;">COMMAND OVERRIDE</div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <button class="btn btn-red" onclick="nuke('markups')">WIPE MAP</button>
                    <button class="btn btn-red" onclick="nuke('units')">WIPE USERS</button>
                    <button class="btn btn-red" onclick="exportData()">EXPORT DATA</button>
                    <button class="btn btn-red" onclick="setAlert()">SET ALERT</button>
                </div>
            </div>

            <input type="text" id="username" class="input-cyber" placeholder="UNIT CALLSIGN">
            <select id="roleSelect" class="input-cyber">
                <option value="blue">üîµ EMPLOYEE</option>
                <option value="red">üî¥ SUPERVISOR</option>
                <option value="green">üü¢ ADMIN</option>
                <option value="white">‚ö™ VOLUNTEER</option>
            </select>
            <button id="trackBtn" class="btn btn-cyan" onclick="toggleTracking()">ACTIVATE BEACON</button>
            <div style="text-align:center; font-size:11px; color:#555; margin-top:10px;">SECURE CONNECTION: ENCRYPTED</div>
        </div>
    </div>

    <div id="panel-assets" class="panel">
        <div class="panel-content">
            <h2>Asset Locker <button style="background:none; border:none; color:var(--success);" onclick="addAsset()">+</button></h2>
            <div id="assetList"></div>
        </div>
    </div>

    <div id="panel-work" class="panel">
        <div class="panel-content">
            <h2>Mission Log</h2>
            <div id="taskInputWrap" style="display:none;">
                <input type="text" id="taskInput" class="input-cyber" placeholder="NEW OBJECTIVE...">
                <button class="btn btn-cyan" onclick="addTask()">ASSIGN</button>
            </div>
            <div id="taskList"></div>
        </div>
    </div>

    <div id="panel-chat" class="panel">
        <div class="panel-content">
            <h2>Comms Channel</h2>
            <div id="chatFeed" style="height:300px; overflow-y:auto; display:flex; flex-direction:column-reverse; margin-bottom:15px; border:1px solid #333; padding:10px; border-radius:8px;"></div>
            <div style="display:flex; gap:10px;">
                <input type="text" id="chatInput" class="input-cyber" style="margin:0;" placeholder="TRANSMIT...">
                <button class="btn btn-cyan" style="width:auto;" onclick="sendMsg()">‚û§</button>
            </div>
        </div>
    </div>

    <nav class="nav-bar">
        <button class="nav-item active" onclick="openPanel('id')">
            <svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
            ID
        </button>
        <button class="nav-item" onclick="openPanel('assets')">
            <svg viewBox="0 0 24 24"><path d="M20 6h-4V4c0-1.11-.89-2-2-2h-4c-1.11 0-2 .89-2 2v2H4c-1.11 0-1.99.89-1.99 2L2 19c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2zm-6 0h-4V4h4v2z"/></svg>
            ASSETS
        </button>
        <button class="nav-item" onclick="openPanel('work')">
            <svg viewBox="0 0 24 24"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg>
            OPS
        </button>
        <button class="nav-item" onclick="openPanel('chat')">
            <svg viewBox="0 0 24 24"><path d="M21 6h-2v9H6v2c0 .55.45 1 1 1h11l4 4V7c0-.55-.45-1-1-1zm-4 6V3c0-.55-.45-1-1-1H3c-.55 0-1 .45-1 1v14l4-4h10c.55 0 1-.45 1-1z"/></svg>
            COMMS
        </button>
    </nav>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <script>
        // --- CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyCZkpLZt-r5e5B-KWBJiiGHMaHY3get6rM",
            authDomain: "sca-tak.firebaseapp.com",
            projectId: "sca-tak",
            storageBucket: "sca-tak.firebasestorage.app",
            messagingSenderId: "1073161858259",
            appId: "1:1073161858259:web:a860ae211ff3d32e1a7826",
            databaseURL: "https://sca-tak-default-rtdb.firebaseio.com"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // --- GATES CONFIG (CORRECTED) ---
        const GATES = {
            'A': [38.528, -76.516], // Aspen
            'B': [38.522, -76.514], // Birch
            'C': [38.515, -76.513], // Cedar (Main)
            'D': [38.510, -76.512], // Dogwood
            'E': [38.503, -76.509]  // Elder
        };

        // --- MAP INIT ---
        const map = L.map('map', { zoomControl: false, attributionControl: false }).setView([38.515, -76.513], 15);
        const tileLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { maxZoom: 20 }).addTo(map);

        // Draw Gates
        for (let g in GATES) {
            L.circle(GATES[g], { color: '#00f0ff', radius: 30, weight: 1 }).addTo(map);
            L.marker(GATES[g], {
                icon: L.divIcon({
                    className: 'gate-label',
                    html: `<div style="color:#00f0ff; font-weight:900; font-family:'Rajdhani'; font-size:14px; text-shadow:0 0 5px #00f0ff;">GATE ${g}</div>`
                })
            }).addTo(map);
        }

        // --- WEATHER (OpenMeteo API) ---
        async function fetchWeather() {
            try {
                const res = await fetch('https://api.open-meteo.com/v1/forecast?latitude=38.51&longitude=-76.51&current_weather=true&temperature_unit=fahrenheit');
                const data = await res.json();
                document.getElementById('weatherTemp').innerText = Math.round(data.current_weather.temperature) + "¬∞F";
                document.getElementById('weatherWind').innerText = data.current_weather.windspeed + " mph";
            } catch (e) { console.log("Weather Error"); }
        }
        fetchWeather(); setInterval(fetchWeather, 600000); // 10 mins

        // --- PANEL LOGIC ---
        let currentPanel = null;
        function openPanel(id) {
            const el = document.getElementById('panel-' + id);
            // Toggle
            if (currentPanel === id && el.classList.contains('open')) {
                el.classList.remove('open');
                currentPanel = null;
                document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
            } else {
                // Close others
                document.querySelectorAll('.panel').forEach(p => p.classList.remove('open'));
                document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
                
                // Open new
                el.classList.add('open');
                // Highlight Nav
                const idx = ['id','assets','work','chat'].indexOf(id);
                document.querySelectorAll('.nav-item')[idx].classList.add('active');
                currentPanel = id;
            }
        }

        // --- SOS LOGIC ---
        let sosTimer;
        function startSOS() {
            document.getElementById('sosBtn').classList.add('active');
            sosTimer = setTimeout(() => {
                const name = document.getElementById('username').value || "UNKNOWN";
                db.ref('alerts/').push({ type: 'SOS', user: name, time: Date.now() });
                navigator.vibrate([500, 200, 500]); // Vibrate
                alert("SOS SIGNAL SENT");
            }, 2000); // Hold for 2 seconds
        }
        function endSOS() {
            clearTimeout(sosTimer);
            document.getElementById('sosBtn').classList.remove('active');
        }

        // --- ALERTS LISTENER ---
        db.ref('alerts/').limitToLast(1).on('child_added', snap => {
            const val = snap.val();
            if (Date.now() - val.time < 10000) { // If new
                document.getElementById('marqueeBox').style.display = 'flex';
                document.getElementById('marqueeText').innerText = `‚ö†Ô∏è SOS SIGNAL: ${val.user} ‚ö†Ô∏è`;
                setTimeout(() => document.getElementById('marqueeBox').style.display = 'none', 30000);
            }
        });

        // --- TRACKING & SPEEDOMETER ---
        let trackId = null;
        let pathLine = null;
        let pathCoords = [];

        function toggleTracking() {
            if (trackId) {
                navigator.geolocation.clearWatch(trackId);
                trackId = null;
                document.getElementById('trackBtn').innerText = "ACTIVATE BEACON";
                document.getElementById('trackBtn').classList.remove('btn-green');
                document.getElementById('trackBtn').classList.add('btn-cyan');
                if(pathLine) map.removeLayer(pathLine);
            } else {
                const name = document.getElementById('username').value;
                if(!name) return alert("ENTER CALLSIGN");
                
                const role = document.getElementById('roleSelect').value;
                const colors = { blue: "#00f0ff", red: "#ff2a6d", green: "#05ffa1", white: "#ffffff" };
                pathCoords = []; // Reset trail

                trackId = navigator.geolocation.watchPosition(pos => {
                    const { latitude, longitude, speed, heading } = pos.coords;
                    
                    // Update Speedometer
                    const mph = speed ? Math.round(speed * 2.237) : 0;
                    document.getElementById('speedVal').innerText = mph;
                    
                    // Update Compass
                    if(heading) {
                        const dirs = ['N','NE','E','SE','S','SW','W','NW'];
                        const dir = dirs[Math.round(heading / 45) % 8];
                        document.getElementById('compassVal').innerText = dir;
                    }

                    // Update DB
                    db.ref('units/' + name).update({
                        lat: latitude, lng: longitude,
                        color: colors[role], role: role,
                        speed: mph, lastSeen: Date.now()
                    });

                    // Draw Breadcrumbs (Local)
                    pathCoords.push([latitude, longitude]);
                    if(pathCoords.length > 50) pathCoords.shift(); // Keep last 50 points
                    if(pathLine) map.removeLayer(pathLine);
                    pathLine = L.polyline(pathCoords, {color: colors[role], weight: 2, opacity: 0.5}).addTo(map);

                    document.getElementById('trackBtn').innerText = "BEACON ACTIVE";
                    document.getElementById('trackBtn').classList.remove('btn-cyan');
                    document.getElementById('trackBtn').classList.add('btn-green');

                }, null, { enableHighAccuracy: true });
            }
        }

        // --- UNIT RENDERING ---
        let unitLayers = {};
        db.ref('units/').on('value', snap => {
            const units = snap.val();
            const now = Date.now();
            
            // Remove old
            for (let n in unitLayers) map.removeLayer(unitLayers[n]);
            unitLayers = {};

            for (let name in units) {
                const u = units[name];
                if (now - u.lastSeen > 3600000) continue; // 1 hr timeout

                const html = `
                    <div style="text-align:center;">
                        <div style="width:12px; height:12px; background:${u.color}; border-radius:50%; box-shadow:0 0 8px ${u.color}; border:2px solid white; margin:0 auto;"></div>
                        <div style="background:rgba(0,0,0,0.7); color:${u.color}; padding:2px 4px; border-radius:4px; font-size:9px; font-weight:bold; margin-top:4px; font-family:'Rajdhani'; white-space:nowrap;">
                            ${name} [${u.speed || 0}]
                        </div>
                    </div>
                `;
                const icon = L.divIcon({ className: 'empty', html: html, iconSize: [40, 40], iconAnchor: [20, 10] });
                unitLayers[name] = L.marker([u.lat, u.lng], { icon: icon }).addTo(map);
            }
        });

        // --- ASSET LOCKER (New Feature) ---
        function addAsset() {
            const item = prompt("Asset Name (e.g. Chainsaw 1):");
            if(item) db.ref('assets/').push({ name: item, checkedOut: false });
        }
        db.ref('assets/').on('value', snap => {
            const list = document.getElementById('assetList');
            list.innerHTML = "";
            snap.forEach(c => {
                const a = c.val();
                const div = document.createElement('div');
                div.className = `list-item ${a.checkedOut ? 'done' : ''}`;
                div.innerHTML = `
                    <span>${a.name}</span>
                    <button class="btn-cyan" style="width:auto; padding:5px 10px; font-size:10px;" onclick="toggleAsset('${c.key}', ${a.checkedOut})">
                        ${a.checkedOut ? 'RETURN' : 'TAKE'}
                    </button>
                `;
                list.appendChild(div);
            });
        });
        window.toggleAsset = (key, stat) => {
            const user = document.getElementById('username').value || "Someone";
            db.ref('assets/' + key).update({ checkedOut: !stat, user: !stat ? user : null });
        };

        // --- UTILS ---
        function toggleNightMode() {
            document.getElementById('map').classList.toggle('night-vision');
        }
        function toggleTorch() {
            const t = document.getElementById('torch-overlay');
            t.style.display = t.style.display === 'block' ? 'none' : 'block';
        }
        function zoomToSCA() { map.setView([38.515, -76.513], 15); }
        function locateMe() { navigator.geolocation.getCurrentPosition(p => map.setView([p.coords.latitude, p.coords.longitude], 17)); }

        // --- ADMIN ---
        let isAdmin = false;
        function toggleAdmin() {
            if (isAdmin) return;
            if (prompt("CODE:") === "SCA2026") {
                isAdmin = true;
                document.getElementById('admin-tools').style.display = 'block';
                document.getElementById('taskInputWrap').style.display = 'block';
                document.getElementById('lockIcon').innerText = "üîì";
            }
        }
        function nuke(node) { if(confirm("CONFIRM WIPE: " + node)) db.ref(node).remove(); }
        
        function exportData() {
            db.ref('/').once('value').then(snap => {
                const data = JSON.stringify(snap.val(), null, 2);
                const blob = new Blob([data], {type: 'text/plain'});
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = 'SCA_LOGS.txt';
                a.click();
            });
        }
        
        function setAlert() {
            const msg = prompt("ALERT MESSAGE:");
            if(msg) {
                document.getElementById('marqueeBox').style.display = 'flex';
                document.getElementById('marqueeText').innerText = "‚ö†Ô∏è " + msg + " ‚ö†Ô∏è";
            } else {
                document.getElementById('marqueeBox').style.display = 'none';
            }
        }

        // --- TASKS & CHAT (Standard) ---
        function addTask() {
            const t = document.getElementById('taskInput').value;
            if(t) { db.ref('tasks/').push({text:t, done:false}); document.getElementById('taskInput').value=""; }
        }
        db.ref('tasks/').on('value', snap => {
            const l = document.getElementById('taskList'); l.innerHTML="";
            snap.forEach(c => {
                const t = c.val();
                l.innerHTML += `<div class="list-item ${t.done?'done':''}" onclick="db.ref('tasks/${c.key}').update({done:!${t.done}})">${t.text}</div>`;
            });
        });

        function sendMsg() {
            const t = document.getElementById('chatInput').value;
            const u = document.getElementById('username').value || "Anon";
            if(t) { db.ref('chat/').push({user:u, text:t}); document.getElementById('chatInput').value=""; }
        }
        db.ref('chat/').limitToLast(20).on('child_added', s => {
            const m = s.val();
            document.getElementById('chatFeed').innerHTML = `<div style="font-size:12px; margin-bottom:5px;"><b style="color:var(--accent)">${m.user}</b>: ${m.text}</div>` + document.getElementById('chatFeed').innerHTML;
        });

    </script>
</body>
</html>
