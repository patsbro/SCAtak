<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>SCAtak | Field Ops</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        :root { --primary: #1a73e8; --bg: #f8f9fa; --danger: #dc2626; --success: #16a34a; }
        body { font-family: -apple-system, system-ui, sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; background: var(--bg); }
        
        #map { flex: 1; width: 100%; z-index: 1; }

        /* Floating Controls */
        .map-controls { position: absolute; top: 10px; right: 10px; z-index: 900; display: flex; flex-direction: column; gap: 8px; }
        .ctrl-btn { background: white; border: 2px solid rgba(0,0,0,0.2); border-radius: 8px; padding: 10px; cursor: pointer; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .ctrl-btn.active { background: var(--success); color: white; border-color: var(--success); }

        /* Dashboard Slide-up */
        .dashboard { 
            height: 40vh; background: white; border-top: 4px solid var(--primary);
            display: flex; flex-direction: column; z-index: 1000;
            box-shadow: 0 -5px 15px rgba(0,0,0,0.15); border-radius: 20px 20px 0 0;
        }

        .tabs { display: flex; border-bottom: 1px solid #ddd; }
        .tab { flex: 1; padding: 15px; text-align: center; cursor: pointer; font-weight: bold; color: #555; }
        .tab.active { color: var(--primary); border-bottom: 3px solid var(--primary); }

        .content-area { flex: 1; overflow-y: auto; padding: 15px; }
        .hidden { display: none; }

        input, select, textarea { width: 100%; padding: 12px; margin: 5px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        .btn { background: var(--primary); color: white; border: none; padding: 14px; width: 100%; border-radius: 8px; font-weight: bold; margin-top: 10px; cursor: pointer; }
        
        .status-badge { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-right: 5px; }
    </style>
</head>
<body>

    <div class="map-controls">
        <button class="ctrl-btn" onclick="toggleLayer()">üó∫Ô∏è Sat/Map</button>
        <button class="ctrl-btn" onclick="zoomToMe()">üìç Center</button>
        <button class="ctrl-btn" id="wakeBtn" onclick="toggleWakeLock()">üí§ Keep Awake</button>
    </div>

    <div id="map"></div>

    <div class="dashboard">
        <div class="tabs">
            <div id="tab-status" class="tab active" onclick="showTab('status')">STATUS</div>
            <div id="tab-board" class="tab" onclick="showTab('board')">MESSAGES</div>
        </div>

        <div id="status-tab" class="content-area">
            <input type="text" id="username" placeholder="Unit Name / ID">
            <select id="userColor">
                <option value="#2563eb">Blue (Standard)</option>
                <option value="#dc2626">Red (Emergency)</option>
                <option value="#16a34a">Green (Safe/Clear)</option>
                <option value="#f59e0b">Orange (Caution)</option>
            </select>
            <select id="userStatus">
                <option value="Active">Status: Active</option>
                <option value="En-Route">Status: En-Route</option>
                <option value="On-Site">Status: On-Site</option>
                <option value="Offline">Status: Offline</option>
            </select>
            <button class="btn" onclick="startTracking()">START TRACKING (AUTO)</button>
            <p style="text-align:center; font-size:0.8rem; color:#666; margin-top:5px;">Updates location every 15s</p>
        </div>

        <div id="board-tab" class="content-area hidden">
            <textarea id="boardInput" placeholder="New update..."></textarea>
            <button class="btn" style="background: #34a853;" onclick="postMessage()">POST</button>
            <div id="messageList" style="margin-top: 15px;"></div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <script>
        // --- CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyCZkpLZt-r5e5B-KWBJiiGHMaHY3get6rM",
            authDomain: "sca-tak.firebaseapp.com",
            projectId: "sca-tak",
            storageBucket: "sca-tak.firebasestorage.app",
            messagingSenderId: "1073161858259",
            appId: "1:1073161858259:web:a860ae211ff3d32e1a7826",
            databaseURL: "https://sca-tak-default-rtdb.firebaseio.com"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // --- MAP LAYERS ---
        const streets = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png');
        const satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri'
        });

        // Setup Map (Calvert Focus)
        const map = L.map('map', {
            layers: [streets], // Default layer
            zoomControl: false // Hide default zoom buttons for mobile space
        }).setView([38.548, -76.584], 11);

        let currentLayer = "streets";
        function toggleLayer() {
            if (currentLayer === "streets") {
                map.removeLayer(streets);
                map.addLayer(satellite);
                currentLayer = "satellite";
            } else {
                map.removeLayer(satellite);
                map.addLayer(streets);
                currentLayer = "streets";
            }
        }

        // --- AUTOMATED TRACKING ---
        let watchID = null;
        let wakeLock = null;

        function startTracking() {
            const name = document.getElementById('username').value;
            if(!name) return alert("Enter Unit Name First");

            if(watchID) navigator.geolocation.clearWatch(watchID);

            // Auto-update every time phone moves
            watchID = navigator.geolocation.watchPosition((pos) => {
                const data = {
                    lat: pos.coords.latitude,
                    lng: pos.coords.longitude,
                    color: document.getElementById('userColor').value,
                    status: document.getElementById('userStatus').value,
                    time: new Date().toLocaleTimeString(),
                    accuracy: pos.coords.accuracy
                };

                // Push to Cloud
                db.ref('employees/' + name).update(data);
                
                // Visual Confirmation
                document.querySelector('.btn').innerText = "TRACKING ACTIVE (‚úÖ)";
                document.querySelector('.btn').style.background = "#16a34a";
            }, (err) => {
                alert("GPS Error: " + err.message);
            }, {
                enableHighAccuracy: true,
                maximumAge: 10000,
                timeout: 5000
            });
        }

        // --- WAKE LOCK (PREVENT SLEEP) ---
        async function toggleWakeLock() {
            if ('wakeLock' in navigator) {
                try {
                    wakeLock = await navigator.wakeLock.request('screen');
                    document.getElementById('wakeBtn').classList.add('active');
                    document.getElementById('wakeBtn').innerText = "‚ö° Awake On";
                } catch (err) {
                    alert("Battery Saver Mode might be blocking this.");
                }
            } else {
                alert("Your browser doesn't support Wake Lock.");
            }
        }

        // --- RENDER TEAM ---
        let userMarkers = {};
        db.ref('employees/').on('value', (snapshot) => {
            const data = snapshot.val();
            if(!data) return;
            for (let id in data) {
                renderMarker(id, data[id]);
            }
        });

        function renderMarker(name, data) {
            if (userMarkers[name]) map.removeLayer(userMarkers[name]);
            
            // Create pulsing marker
            const iconHtml = `<div style="
                background:${data.color}; width:16px; height:16px; 
                border-radius:50%; border:3px solid white; 
                box-shadow: 0 0 10px ${data.color};"></div>`;
                
            const customIcon = L.divIcon({ html: iconHtml, className: 'custom-pin', iconSize: [20, 20] });
            
            userMarkers[name] = L.marker([data.lat, data.lng], {icon: customIcon}).addTo(map)
                .bindPopup(`<b>${name}</b><br>${data.status}<br><small>${data.time}</small>`);
        }

        // --- UI UTILS ---
        function showTab(tab) {
            document.querySelectorAll('.content-area').forEach(el => el.classList.add('hidden'));
            document.getElementById(tab+'-tab').classList.remove('hidden');
            document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
            document.getElementById('tab-'+tab).classList.add('active');
        }
        function zoomToMe() {
            navigator.geolocation.getCurrentPosition(pos => {
                map.setView([pos.coords.latitude, pos.coords.longitude], 15);
            });
        }
        
        // Message Board Logic (Simplified)
        function postMessage() {
            const text = document.getElementById('boardInput').value;
            const user = document.getElementById('username').value || 'Unknown';
            if(text) db.ref('messages/').push({user, text, time: new Date().toLocaleTimeString()});
            document.getElementById('boardInput').value = "";
        }
        db.ref('messages/').limitToLast(10).on('child_added', s => {
            const m = s.val();
            document.getElementById('messageList').innerHTML = `<div style="background:#eee; padding:8px; margin-bottom:5px; border-radius:5px;"><b>${m.user}:</b> ${m.text}</div>` + document.getElementById('messageList').innerHTML;
        });

    </script>
</body>
</html>
